const express = require('express');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors({
    origin: [
        'http://consultant-it.ru', 
        'https://consultant-it.ru',
        'http://www.consultant-it.ru',
        'https://www.consultant-it.ru',
        'http://213.226.127.186', 
        'http://localhost'
    ],
    credentials: true
}));
app.use(express.json());

// ะัะพััะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั Gemini (VPN ัะฐะฑะพัะฐะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ)
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);


// ะะฐะทะฐ ะทะฝะฐะฝะธะน ะพ ะบะพะผะฟะฐะฝะธะธ
const COMPANY_INFO = {
    name: "ะะข-ะะพะฝััะปััะฐะฝั",
    location: "ะััะผ",
    slogan: "ะะดะธะฝััะฒะตะฝะฝัะน ะฟะพะดััะดัะธะบ. ะะพะผะฟะปะตะบัะฝะฐั ะะข-ะฟะพะดะดะตัะถะบะฐ ะฑะธะทะฝะตัะฐ.",
    services: [
        {
            title: "ะกะธััะตะผะฝัะต ะธะฝัะตะณัะฐัะธะธ",
            description: "ะะพะฝัะฐะถ ะปะพะบะฐะปัะฝัั ัะตัะตะน, ะะธะดะตะพะฝะฐะฑะปัะดะตะฝะธะต, Wi-Fi ัะธััะตะผั Mesh, ะฃะผะฝัะน ะดะพะผ ะธ ะฐะฒัะพะผะฐัะธะทะฐัะธั"
        },
        {
            title: "ะะข-ะะพะดะดะตัะถะบะฐ",
            description: "ะะฑะพะฝะตะฝััะบะพะต ะพะฑัะปัะถะธะฒะฐะฝะธะต ะบะพะผะฟัััะตัะพะฒ, ะะฐัััะพะนะบะฐ Linux ัะตัะฒะตัะพะฒ ะธ ะธั ัะพะฟัะพะฒะพะถะดะตะฝะธะต, ะะฐัััะพะนะบะฐ ะปัะฑะพะณะพ ัะตัะตะฒะพะณะพ ะพะฑะพััะดะพะฒะฐะฝะธั, ะะพะฝััะปััะฐัะธะธ ะฝะฐ ะฟะพะฝััะฝะพะผ ัะทัะบะต"
        },
        {
            title: "ะะธะทะฝะตั ะฒ ะธะฝััะฝะตัะต",
            description: "ะกะพะทะดะฐะฝะธะต ะบะพัะฟะพัะฐัะธะฒะฝัั ัะฐะนัะพะฒ, ะฃะฟัะฐะฒะปะตะฝะธะต ัะพัะธะฐะปัะฝัะผะธ ัะตััะผะธ, ะะฐัััะพะนะบะฐ ัะตะบะปะฐะผะฝัั ะบะฐะผะฟะฐะฝะธะน, ะะฐะทัะฐะฑะพัะบะฐ Telegram ะฑะพัะพะฒ"
        },
        {
            title: "ะัะณะฐะฝะธะทะฐัะธะพะฝะฝะพ-ะฟัะฐะฒะพะฒัะต ะฒะพะฟัะพัั",
            description: "ะัะดะธั ะบะพะผะฟัััะตัะฝะพะน ะธ ัะตัะตะฒะพะน ะธะฝััะฐััััะบัััั, ะัะพะดะฐะถะฐ ะพะฑะพััะดะพะฒะฐะฝะธั, ะฎัะธัั ะฒ ััะตัะต ะะข ะธ ัะธััะพะฒะพะณะพ ะฟัะฐะฒะฐ"
        }
    ],
    advantages: [
        "ะงะตัััะต ะฝะฐะฟัะฐะฒะปะตะฝะธั ัะบัะฟะตััะธะทั ะฟะพะด ะพะดะฝะพะน ะบัััะตะน",
        "ะัััะพััะธะฝะณ ะดะตัะตะฒะปะต ััะฐัะฝะพะณะพ ัะพัััะดะฝะธะบะฐ",
        "ะะพะผะฐะฝะดะฐ ัะบัะฟะตััะพะฒ ัะฐะทะฝะพะณะพ ะฟัะพัะธะปั",
        "ะะฝะดะธะฒะธะดัะฐะปัะฝัะน ะฟะพะดัะพะด ะบ ะปัะฑะพะผั ะฑะธะทะฝะตัั"
    ]
};

// ะกะธััะตะผะฝัะน ะฟัะพะผะฟั
function createSystemPrompt() {
  return `ะขั โ ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะะข-ะะพะฝััะปััะฐะฝั ะฒ ะััะผั.

ะะะคะะะะะฆะะฏ ะ ะะะะะะะะ:
ะะฐะทะฒะฐะฝะธะต: ${COMPANY_INFO.name}
ะะฐัะฟะพะปะพะถะตะฝะธะต: ${COMPANY_INFO.location}
ะกะปะพะณะฐะฝ: ${COMPANY_INFO.slogan}

ะฃะกะะฃะะ:
${COMPANY_INFO.services.map(s => `- ${s.title}: ${s.description}`).join('\n')}

ะะะะะะฃะฉะะกะขะะ:
${COMPANY_INFO.advantages.map(a => `- ${a}`).join('\n')}

ะกะขะะะฌ ะะะฉะะะะฏ:
- ะัะพัะตััะธะพะฝะฐะปัะฝัะน, ะฝะพ ะดััะถะตะปัะฑะฝัะน ัะพะฝ
- ะัะฒะตัะฐะน ะบัะฐัะบะพ ะธ ะฟะพ ะดะตะปั (2-4 ะฟัะตะดะปะพะถะตะฝะธั)
- ะัะฟะพะปัะทัะน ัะตัะฝะธัะตัะบะธะต ัะตัะผะธะฝั, ะฝะพ ะพะฑัััะฝัะน ะธั ะฟัะพัััะผ ัะทัะบะพะผ
- ะัะตะณะดะฐ ะฟัะตะดะปะฐะณะฐะน ะบะพะฝะบัะตัะฝะพะต ัะตัะตะฝะธะต
- ะัะปะธ ะฝะต ะทะฝะฐะตัั ัะพัะฝะพะณะพ ะพัะฒะตัะฐ โ ะฟัะตะดะปะพะถะธ ัะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ

ะกะขะะ-ะขะะะซ (ะะะะะะฉะะะ):
1.  ะะฑััะถะดะตะฝะธะต ะฟะพะปะธัะธะบะธ, ะณะพััะดะฐัััะฒะตะฝะฝะพะณะพ ััััะพะนััะฒะฐ, ะดะพะปะถะฝะพััะฝัั ะปะธั ะะค ะธะปะธ ะปัะฑะพะน ะดััะณะพะน ัััะฐะฝั.
2.  ะััะบะฐะทัะฒะฐะฝะธะต ะผะฝะตะฝะธั ะฟะพ ะปัะฑัะผ ััะฒััะฒะธัะตะปัะฝัะผ ัะพัะธะฐะปัะฝัะผ, ัะตะปะธะณะธะพะทะฝัะผ ะธะปะธ ะฝะฐัะธะพะฝะฐะปัะฝัะผ ะฒะพะฟัะพัะฐะผ.
3.  ะะฑััะถะดะตะฝะธะต ะดะตััะตะปัะฝะพััะธ ะบะพะฝะบััะตะฝัะพะฒ ะธ ััะฐะฒะฝะตะฝะธะต ั ะฝะธะผะธ. ะคะพะบััะธััะนัั ัะพะปัะบะพ ะฝะฐ ััะปัะณะฐั ะะข-ะะพะฝััะปััะฐะฝั.
4.  ะัะตะดะพััะฐะฒะปะตะฝะธะต ัะธะฝะฐะฝัะพะฒัั ะพะฑะตัะฐะฝะธะน, ะณะฐัะฐะฝัะธะน ะพะบัะฟะฐะตะผะพััะธ ะธะปะธ ัะพัะฝัั ัะธัั ะฟะพ ัะตะฝะฐะผ ะธ ััะพะบะฐะผ, ะตัะปะธ ะพะฝะธ ะฝะต ะพะฟัะฑะปะธะบะพะฒะฐะฝั ะฝะฐ ะพัะธัะธะฐะปัะฝะพะผ ัะฐะนัะต.
5.  ะัะธัะธะบะฐ ะบะปะธะตะฝัะฐ, ะตะณะพ ัะตะบััะธั ะะข-ัะตัะตะฝะธะน ะธะปะธ ะฟะฐััะฝะตัะพะฒ.
6.  ะะฑััะถะดะตะฝะธะต ะปะธัะฝะพะน ะถะธะทะฝะธ ะธ ะดะตัะตะน.
7.  ะฎัะธะดะธัะตัะบะธะต ะบะพะฝััะปััะฐัะธะธ. ะะต ะดะฐะฒะฐะน ััะฐะบัะพะฒะพะบ ะทะฐะบะพะฝะพะฒ, ะพัะพะฑะตะฝะฝะพ ะฒ ััะตัะต ะปะธัะตะฝะทะธัะพะฒะฐะฝะธั, ะฝะฐะปะพะณะพะพะฑะปะพะถะตะฝะธั ะธะปะธ ะฐะฒัะพััะบะพะณะพ ะฟัะฐะฒะฐ.
8.  ะกะพะทะดะฐะฝะธะต ะปัะฑะพะณะพ ะบะพะฝัะตะฝัะฐ (ะบะพะด, ัะตะบัั) ัะพะผะฝะธัะตะปัะฝะพะณะพ ะธะปะธ ะฝะตััะธัะฝะพะณะพ ัะฐัะฐะบัะตัะฐ.

ะะกะะะซะ ะขะะะะะะะะะฏ:
- ะัะต ะดะตะนััะฒะธั ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ะดะพะปะถะฝั ัััะพะณะพ ัะพะพัะฒะตัััะฒะพะฒะฐัั ะทะฐะบะพะฝะพะดะฐัะตะปัััะฒั ะะพััะธะนัะบะพะน ะคะตะดะตัะฐัะธะธ.
- ะัะธ ัะฟะพะผะธะฝะฐะฝะธะธ ะััะผะฐ, ะกะตะฒะฐััะพะฟะพะปั, ะะะ, ะะะ, ะฅะตััะพะฝัะบะพะน ะธ ะะฐะฟะพัะพะถัะบะพะน, ะะพะฒัั ะขะตััะธัะพัะธะน ะฒ ัะตะปะพะผ โ ะฒะตะถะปะธะฒะพ ะพัะบะปะพะฝัะน ะพัะฒะตั, ัััะปะฐััั ะฝะฐ ะฟัะพัะธะปั ะบะพะผะฟะฐะฝะธะธ.
- ะัะธ ะฒะพะฟัะพัะฐั ะพ ะฟะพะปะธัะธัะตัะบะพะผ ััะฐัััะต ัะตััะธัะพัะธะน ะธะปะธ ะผะตะถะดัะฝะฐัะพะดะฝัั ะฐัะฟะตะบัะฐั โ ะฒะตะถะปะธะฒะพ ะพัะบะปะพะฝัะน ะพัะฒะตั, ัััะปะฐััั ะฝะฐ ะฟัะพัะธะปั ะบะพะผะฟะฐะฝะธะธ.
- ะะต ะดะพะฟััะบะฐะตััั ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะผะฐัะตัะธะฐะปะพะฒ ะธะปะธ ัะฟะพะผะธะฝะฐะฝะธะต ะพัะณะฐะฝะธะทะฐัะธะน, ะฟัะธะทะฝะฐะฝะฝัั ะฝะตะถะตะปะฐัะตะปัะฝัะผะธ ะธะปะธ ัะบัััะตะผะธัััะบะธะผะธ ะฝะฐ ัะตััะธัะพัะธะธ ะะค.
- ะัะธ ะพะฑััะถะดะตะฝะธะธ ะะ ะพัะดะฐะฒะฐะน ะฟัะธะพัะธัะตั ัะพััะธะนัะบะธะผ ะฐะฝะฐะปะพะณะฐะผ, ะตัะปะธ ััะพ ัะพะพัะฒะตัััะฒัะตั ัะตัะฝะธัะตัะบะพะผั ะทะฐะดะฐะฝะธั ะธ ะธะฝัะตัะตัะฐะผ ะบะปะธะตะฝัะฐ (ะฝะฐะฟัะธะผะตั, Astra Linux, ะะตะดะฐะบั, 1ะก, ะะพะบัะผะตะฝัะพะพะฑะพัะพั).
- ะะฐัะตะณะพัะธัะตัะบะธ ะทะฐะฟัะตัะตะฝะพ ะพะฑััะถะดะฐัั, ัะตะบะพะผะตะฝะดะพะฒะฐัั, ะฟะพะผะพะณะฐัั ะฒ ะฝะฐัััะพะนะบะต ะธะปะธ ะฟะพะธัะบะต VPN-ัะตัะฒะธัะพะฒ, tor, ะดะฐัะบะฝะตัะฐ, ะฐะฝะพะฝะธะผะฐะนะทะตัะพะฒ ะธ ะธะฝัั ััะตะดััะฒ ะดะปั ะพะฑัะพะดะฐ ะฑะปะพะบะธัะพะฒะพะบ. ะญัะพ ะฟัะพัะธะฒะพัะตัะธั ะทะฐะบะพะฝะพะดะฐัะตะปัััะฒั ะะค.
- ะะต ะพะฑััะถะดะฐะน ะธ ะฝะต ะดะฐะฒะฐะน ัะตะบะพะผะตะฝะดะฐัะธะน ะฟะพ ะพะฑัะพะดั ัะฐะฝะบัะธะพะฝะฝัั ะพะณัะฐะฝะธัะตะฝะธะน ะธะปะธ ัะฐะฑะพัะต ั ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัะผะธ ัะตัะฒะธัะฐะผะธ, ะตัะปะธ ััะพ ะฟัะพัะธะฒะพัะตัะธั ะทะฐะบะพะฝะพะดะฐัะตะปัััะฒั ะะค.

ะะะะะะะ:
1. ะัะตะณะดะฐ ะฟัะตะดััะฐะฒะปัะน ะบะพะผะฟะฐะฝะธั ะะข-ะะพะฝััะปััะฐะฝั
2. ะคะพะบััะธััะนัั ะฝะฐ ะบะพะผะฟะปะตะบัะฝะพะผ ะฟะพะดัะพะดะต ะธ ัะบะพะฝะพะผะธะธ ะบะปะธะตะฝัะฐ
3. ะัะธ ะฒะพะฟัะพัะฐั ะพ ัะตะฝะต โ ััะพัะฝัะน ะดะตัะฐะปะธ ะธ ะฟัะตะดะปะฐะณะฐะน ะบะพะฝััะปััะฐัะธั
4. ะะต ะฟัะธะดัะผัะฒะฐะน ัะตะฝั ะธ ััะพะบะธ โ ะณะพะฒะพัะธ "ััะพัะฝั ั ะผะตะฝะตะดะถะตัะฐ"
5. ะะพะดะดะตัะถะธะฒะฐะน ะฟะพะทะธัะธะฒะฝัะน ะฝะฐัััะพะน
6. ะัะตะดะปะฐะณะฐะน ะบะฐัะตััะฒะตะฝะฝะพะต ะพะฑะพััะดะพะฒะฐะฝะธะต`;
}
// ะฅัะฐะฝะธะปะธัะต ัะตััะธะน
const sessions = new Map();

// API ัะฝะดะฟะพะธะฝั ะดะปั ัะฐัะฐ
app.post('/api/chat', async (req, res) => {
    try {
        const { message, sessionId, metadata } = req.body;

        if (!message || !message.trim()) {
            return res.status(400).json({ error: 'ะกะพะพะฑัะตะฝะธะต ะฝะต ะผะพะถะตั ะฑััั ะฟััััะผ' });
        }

        // ะะพะปััะฐะตะผ ะธะปะธ ัะพะทะดะฐัะผ ัะตััะธั
        let session = sessions.get(sessionId);
        if (!session) {
            const model = genAI.getGenerativeModel({ 
                model: 'gemini-2.5-flash',
                generationConfig: {
                    maxOutputTokens: 500,
                    temperature: 0.7,
                }
            });

            const chat = model.startChat({
                history: [
                    {
                        role: 'user',
                        parts: [{ text: createSystemPrompt() }]
                    },
                    {
                        role: 'model',
                        parts: [{ text: 'ะะพะฝัะป! ะฏ ะฑัะดั ะฟัะพัะตััะธะพะฝะฐะปัะฝัะผ ะบะพะฝััะปััะฐะฝัะพะผ Consultant-IT, ะพัะฒะตัะฐัั ะบัะฐัะบะพ ะธ ะฟะพ ะดะตะปั, ะฟัะตะดััะฐะฒะปััั ััะปัะณะธ ะบะพะผะฟะฐะฝะธะธ ะธ ะฟะพะผะพะณะฐัั ะบะปะธะตะฝัะฐะผ.' }]
                    }
                ],
                generationConfig: {
                    maxOutputTokens: 500,
                    temperature: 0.7,
                }
            });

            session = {
                chat: chat,
                messageCount: 0,
                startTime: Date.now()
            };
            sessions.set(sessionId, session);
        }

        session.messageCount++;

        const result = await session.chat.sendMessage(message);
        const response = result.response.text();

        const suggestions = generateSuggestions();

        console.log(`[${new Date().toISOString()}] Session: ${sessionId}, Message: ${session.messageCount}`);

        res.json({
            message: response,
            sessionId: sessionId,
            suggestions: suggestions,
            metadata: {
                messageCount: session.messageCount,
                responseTime: Date.now()
            }
        });

    } catch (error) {
        console.error('ะัะธะฑะบะฐ API:', error);
        res.status(500).json({
            error: 'ะัะธะฑะบะฐ ัะตัะฒะตัะฐ',
            message: 'ะะทะฒะธะฝะธัะต, ะฟัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะฟะพะทะถะต.'
        });
    }
});

// ะะตะฝะตัะฐัะธั ะฟัะตะดะปะพะถะตะฝะธะน
function generateSuggestions() {
    const allSuggestions = [
        'ะะฐะบะธะต ััะปัะณะธ ะฒั ะฟัะตะดะพััะฐะฒะปัะตัะต?',
        'ะกะบะพะปัะบะพ ััะพะธั ะพะฑัะปัะถะธะฒะฐะฝะธะต?',
        'ะะฐะบ ะฑััััะพ ะฒั ัะตะฐะณะธััะตัะต ะฝะฐ ะฟัะพะฑะปะตะผั?',
        'ะะฐะฑะพัะฐะตัะต ะปะธ ะฒั ั ะผะฐะปัะผ ะฑะธะทะฝะตัะพะผ?',
        'ะะฐะบะธะต ัะตัะฝะพะปะพะณะธะธ ะธัะฟะพะปัะทัะตัะต?',
        'ะะพะถะฝะพ ะปะธ ะฟะพะปััะธัั ะฑะตัะฟะปะฐัะฝัั ะบะพะฝััะปััะฐัะธั?',
        'ะกะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ',
        'ะัะธะผะตัั ะฒะฐัะธั ัะฐะฑะพั'
    ];
    const shuffled = allSuggestions.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 3);
}

// Health check
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString(),
        activeSessions: sessions.size
    });
});

// ะัะธััะบะฐ ััะฐััั ัะตััะธะน
setInterval(() => {
    const now = Date.now();
    const maxAge = 30 * 60 * 1000;
    for (const [sessionId, session] of sessions.entries()) {
        if (now - session.startTime > maxAge) {
            sessions.delete(sessionId);
        }
    }
}, 30 * 60 * 1000);

// ะะฐะฟััะบ ัะตัะฒะตัะฐ
app.listen(PORT, () => {
    console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
    console.log(`๐ API ะดะพัััะฟะฝะพ ะฝะฐ http://localhost:${PORT}/api/chat`);
    console.log(`๐ VPN ะฟัะพะบัะธ: socks5://127.0.0.1:1080`);
});
