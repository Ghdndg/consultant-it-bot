const express = require('express');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors({
    origin: ['https://consultant-it.ru', 'http://localhost'], // ะะฐะทัะตัะตะฝะฝัะต ะดะพะผะตะฝั
    credentials: true
}));
app.use(express.json());

// ะะฝะธัะธะฐะปะธะทะฐัะธั Gemini
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// ะะฐะทะฐ ะทะฝะฐะฝะธะน ะพ ะบะพะผะฟะฐะฝะธะธ
const COMPANY_INFO = {
    name: "Consultant-IT",
    location: "ะััะผ",
    slogan: "ะะดะธะฝััะฒะตะฝะฝัะน ะฟะพะดััะดัะธะบ. ะะพะผะฟะปะตะบัะฝะฐั ะะข-ะฟะพะดะดะตัะถะบะฐ ะฑะธะทะฝะตัะฐ.",
    services: [
        {
            title: "ะกะธััะตะผะฝะพะต ะฐะดะผะธะฝะธัััะธัะพะฒะฐะฝะธะต",
            description: "ะะพะปะฝะพะต ะพะฑัะปัะถะธะฒะฐะฝะธะต ะะข-ะธะฝััะฐััััะบัััั ะฒะฐัะตะณะพ ะฑะธะทะฝะตัะฐ"
        },
        {
            title: "ะฆะธััะพะฒะพะน ะผะฐัะบะตัะธะฝะณ",
            description: "SEO, ะบะพะฝัะตะบััะฝะฐั ัะตะบะปะฐะผะฐ, SMM, ะฒะตะฑ-ะฐะฝะฐะปะธัะธะบะฐ"
        },
        {
            title: "ะฎัะธะดะธัะตัะบะพะต ัะพะฟัะพะฒะพะถะดะตะฝะธะต",
            description: "ะะพะฝััะปััะฐัะธะธ ะฟะพ ะะข ะธ ัะธััะพะฒะพะผั ะฟัะฐะฒั"
        },
        {
            title: "ะะตะฑ-ัะฐะทัะฐะฑะพัะบะฐ",
            description: "ะกะพะทะดะฐะฝะธะต ัะฐะนัะพะฒ, ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะน ะธ ะฐะฒัะพะผะฐัะธะทะฐัะธั"
        }
    ],
    advantages: [
        "ะงะตัััะต ะฝะฐะฟัะฐะฒะปะตะฝะธั ัะบัะฟะตััะธะทั ะฟะพะด ะพะดะฝะพะน ะบัััะตะน",
        "ะัััะพััะธะฝะณ ะดะตัะตะฒะปะต ััะฐัะฝะพะณะพ ัะพัััะดะฝะธะบะฐ",
        "ะะพะผะฐะฝะดะฐ ัะบัะฟะตััะพะฒ ัะฐะทะฝะพะณะพ ะฟัะพัะธะปั",
        "ะะฝะดะธะฒะธะดัะฐะปัะฝัะน ะฟะพะดัะพะด ะบ ะปัะฑะพะผั ะฑะธะทะฝะตัั"
    ],
    targetAudience: [
        "ะกัะฐััะฐะฟั ะธ ัะฐััััะธะน ะฑะธะทะฝะตั",
        "ะะพะผะฟะฐะฝะธะธ ั ัััะตััะฒัััะตะน ะะข-ะธะฝััะฐััััะบัััะพะน",
        "ะัะดะถะตัะฝัะต ะธ ะพะฑัะตััะฒะตะฝะฝัะต ะพัะณะฐะฝะธะทะฐัะธะธ"
    ]
};

// ะกะธััะตะผะฝัะน ะฟัะพะผะฟั
function createSystemPrompt() {
    return `ะขั โ ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะะข-ะบะพะฝััะปััะฐะฝั ะบะพะผะฟะฐะฝะธะธ Consultant-IT ะฒ ะััะผั.

ะะะคะะะะะฆะะฏ ะ ะะะะะะะะ:
ะะฐะทะฒะฐะฝะธะต: ${COMPANY_INFO.name}
ะะฐัะฟะพะปะพะถะตะฝะธะต: ${COMPANY_INFO.location}
ะกะปะพะณะฐะฝ: ${COMPANY_INFO.slogan}

ะฃะกะะฃะะ:
${COMPANY_INFO.services.map(s => `- ${s.title}: ${s.description}`).join('\n')}

ะะะะะะฃะฉะะกะขะะ:
${COMPANY_INFO.advantages.map(a => `- ${a}`).join('\n')}

ะฆะะะะะะฏ ะะฃะะะขะะะะฏ:
${COMPANY_INFO.targetAudience.map(t => `- ${t}`).join('\n')}

ะกะขะะะฌ ะะะฉะะะะฏ:
- ะัะพัะตััะธะพะฝะฐะปัะฝัะน, ะฝะพ ะดััะถะตะปัะฑะฝัะน ัะพะฝ
- ะัะฒะตัะฐะน ะบัะฐัะบะพ ะธ ะฟะพ ะดะตะปั (2-4 ะฟัะตะดะปะพะถะตะฝะธั)
- ะัะฟะพะปัะทัะน ัะตัะฝะธัะตัะบะธะต ัะตัะผะธะฝั, ะฝะพ ะพะฑัััะฝัะน ะธั ะฟัะพัััะผ ัะทัะบะพะผ
- ะัะตะณะดะฐ ะฟัะตะดะปะฐะณะฐะน ะบะพะฝะบัะตัะฝะพะต ัะตัะตะฝะธะต
- ะัะปะธ ะฝะต ะทะฝะฐะตัั ัะพัะฝะพะณะพ ะพัะฒะตัะฐ โ ะฟัะตะดะปะพะถะธ ัะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ

ะะะะะะะ:
1. ะัะตะณะดะฐ ะฟัะตะดััะฐะฒะปัะน ะบะพะผะฟะฐะฝะธั Consultant-IT
2. ะคะพะบััะธััะนัั ะฝะฐ ะบะพะผะฟะปะตะบัะฝะพะผ ะฟะพะดัะพะดะต ะธ ัะบะพะฝะพะผะธะธ ะบะปะธะตะฝัะฐ
3. ะัะธ ะฒะพะฟัะพัะฐั ะพ ัะตะฝะต โ ััะพัะฝัะน ะดะตัะฐะปะธ ะธ ะฟัะตะดะปะฐะณะฐะน ะบะพะฝััะปััะฐัะธั
4. ะะต ะฟัะธะดัะผัะฒะฐะน ัะตะฝั ะธ ััะพะบะธ โ ะณะพะฒะพัะธ "ััะพัะฝั ั ะผะตะฝะตะดะถะตัะฐ"
5. ะะพะดะดะตัะถะธะฒะฐะน ะฟะพะทะธัะธะฒะฝัะน ะฝะฐัััะพะน`;
}

// ะฅัะฐะฝะธะปะธัะต ัะตััะธะน
const sessions = new Map();

// API ัะฝะดะฟะพะธะฝั ะดะปั ัะฐัะฐ
app.post('/api/chat', async (req, res) => {
    try {
        const { message, sessionId, metadata } = req.body;

        if (!message || !message.trim()) {
            return res.status(400).json({ error: 'ะกะพะพะฑัะตะฝะธะต ะฝะต ะผะพะถะตั ะฑััั ะฟััััะผ' });
        }

        // ะะพะปััะฐะตะผ ะธะปะธ ัะพะทะดะฐัะผ ัะตััะธั
        let session = sessions.get(sessionId);
        if (!session) {
            const model = genAI.getGenerativeModel({ 
                model: 'gemini-pro',
                generationConfig: {
                    maxOutputTokens: 500,
                    temperature: 0.7,
                }
            });
            const chat = model.startChat({
                history: [],
                generationConfig: {
                    maxOutputTokens: 500,
                },
            });
            session = { chat, messageCount: 0, startTime: Date.now() };
            sessions.set(sessionId, session);
        }

        // ะะพะฑะฐะฒะปัะตะผ ัะธััะตะผะฝัะน ะฟัะพะผะฟั ะฒ ะฟะตัะฒะพะต ัะพะพะฑัะตะฝะธะต
        let fullMessage = message;
        if (session.messageCount === 0) {
            fullMessage = createSystemPrompt() + '\n\nะะตัะฒัะน ะฒะพะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั: ' + message;
        }

        // ะัะฟัะฐะฒะปัะตะผ ะทะฐะฟัะพั ะฒ Gemini
        const result = await session.chat.sendMessage(fullMessage);
        const response = result.response.text();

        session.messageCount++;

        // ะะตะฝะตัะธััะตะผ ัะตะปะตะฒะฐะฝัะฝัะต ะฟัะตะดะปะพะถะตะฝะธั
        const suggestions = generateSuggestions(message, response);

        // ะะพะณะธััะตะผ
        console.log(`[${new Date().toISOString()}] Session: ${sessionId}, Message: ${session.messageCount}`);

        res.json({
            message: response,
            sessionId: sessionId,
            suggestions: suggestions,
            metadata: {
                messageCount: session.messageCount,
                responseTime: Date.now()
            }
        });

    } catch (error) {
        console.error('ะัะธะฑะบะฐ API:', error);
        res.status(500).json({
            error: 'ะัะธะฑะบะฐ ัะตัะฒะตัะฐ',
            message: 'ะะทะฒะธะฝะธัะต, ะฟัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะฟะพะทะถะต.'
        });
    }
});

// ะะตะฝะตัะฐัะธั ัะตะปะตะฒะฐะฝัะฝัั ะฟัะตะดะปะพะถะตะฝะธะน
function generateSuggestions(userMessage, botResponse) {
    const allSuggestions = [
        'ะะฐะบะธะต ััะปัะณะธ ะฒั ะฟัะตะดะพััะฐะฒะปัะตัะต?',
        'ะกะบะพะปัะบะพ ััะพะธั ะพะฑัะปัะถะธะฒะฐะฝะธะต?',
        'ะะฐะบ ะฑััััะพ ะฒั ัะตะฐะณะธััะตัะต ะฝะฐ ะฟัะพะฑะปะตะผั?',
        'ะะฐะฑะพัะฐะตัะต ะปะธ ะฒั ั ะผะฐะปัะผ ะฑะธะทะฝะตัะพะผ?',
        'ะะฐะบะธะต ัะตัะฝะพะปะพะณะธะธ ะธัะฟะพะปัะทัะตัะต?',
        'ะะพะถะฝะพ ะปะธ ะฟะพะปััะธัั ะฑะตัะฟะปะฐัะฝัั ะบะพะฝััะปััะฐัะธั?',
        'ะกะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ',
        'ะัะธะผะตัั ะฒะฐัะธั ัะฐะฑะพั'
    ];

    // ะัะพััะฐั ะปะพะณะธะบะฐ ะฒัะฑะพัะฐ 3 ัะตะปะตะฒะฐะฝัะฝัั ะฟัะตะดะปะพะถะตะฝะธะน
    const shuffled = allSuggestions.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 3);
}

// Health check
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString(),
        activeSessions: sessions.size
    });
});

// ะัะธััะบะฐ ััะฐััั ัะตััะธะน (ะบะฐะถะดัะต 30 ะผะธะฝัั)
setInterval(() => {
    const now = Date.now();
    const maxAge = 30 * 60 * 1000; // 30 ะผะธะฝัั
    
    for (const [sessionId, session] of sessions.entries()) {
        if (now - session.startTime > maxAge) {
            sessions.delete(sessionId);
            console.log(`ะกะตััะธั ${sessionId} ัะดะฐะปะตะฝะฐ (ะธััะตะบะปะพ ะฒัะตะผั)`);
        }
    }
}, 30 * 60 * 1000);

// ะะฐะฟััะบ ัะตัะฒะตัะฐ
app.listen(PORT, () => {
    console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
    console.log(`๐ API ะดะพัััะฟะฝะพ ะฝะฐ http://localhost:${PORT}/api/chat`);
});
